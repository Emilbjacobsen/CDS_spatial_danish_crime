---
title: "crime_municipalities"
author: "Nikita"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r libraries, include=FALSE}
# Library 
library(raster)
library(rgeos)
library(sf)
library(tidyverse)
library(htmltools)
library(googlesheets4)
library(mapview)
library(leaflet)
library(shiny)
```


```{r load-municipalities-spatial-data, echo = FALSE}

# Load the spatial data, project to UTM
mun_sp<- getData('GADM', country = 'DK', level = 2)
mun_sf <- st_as_sf(mun_sp)
mun <- st_transform(mun_sf, crs = 25832)
st_crs(mun)

# Plot so as to check correct location and complete coverage
plot(mun$geometry)

# Check the names
mun$NAME_2

# Straighten the names (return here after Task 2)
mun$NAME_2[31] <- "Aarhus"
mun$NAME_2[21] <- "HÃ¸je-Taastrup"
mun$NAME_2[60] <- "Vesthimmerlands"


```


```{r load vold }
# read in data from csv
voldsforbrydelser <- read_csv2("data/voldsforbrydelser_numbers.csv")
# delete row 1 and 3 and column 1
voldsforbrydelser <- voldsforbrydelser[-c(1,3), -1]
#rename colums with names of the first row
colnames(voldsforbrydelser) <- voldsforbrydelser[1, ]
# delete row with rownames
voldsforbrydelser <- voldsforbrydelser[-1,]
# drop NA-rows
voldsforbrydelser <- voldsforbrydelser[complete.cases(voldsforbrydelser), ]
#drop 'ukendt kommune' row
voldsforbrydelser <- voldsforbrydelser[-100,]
# pasting 'Y' before columnname
colnames(voldsforbrydelser) <- paste0("Y", colnames(voldsforbrydelser))
# rename the first column
colnames(voldsforbrydelser)[1] <- "municipalities"

# assign numbers as numbers
voldsforbrydelser[,2:21] <- sapply(voldsforbrydelser[ ,2:21], as.numeric)
# getting sum of rows
voldsforbrydelser$crime_sum <- rowSums(voldsforbrydelser[,2:21])


```

```{r}

vold <- mun %>% 
  select(NAME_2) %>% 
  merge(voldsforbrydelser, by.x = "NAME_2",by.y ="municipalities")

```

```{r}
percentage_cols <- vold[,2:21] / vold$crime_sum*100

vold[,2:21] <- percentage_cols
```

```{r}
# Map some aspect of the result to see no counties are missing
vold %>% 
  group_by(NAME_2) %>% 
  select(Y2018K1) %>% 
  mapview()
```



```{r}
library(leaflet)
library(shiny)

# Assuming you have your merged dataset with municipality boundaries and crime rate for each time period
# Create a leaflet map
leaflet() %>%
  addTiles() %>%
  addPolygons(data = merged_data, fillColor = ~color_variable, fillOpacity = 0.7,
              color = "white", weight = 1) %>%
  addLegend("bottomright", colors = "your_color_palette", labels = "Time Period",
            title = "Crime Rate") %>%
  addControl(
    sliderControl(
      position = "bottomleft",
      step = 1,
      min = min(merged_data$time_variable),
      max = max(merged_data$time_variable),
      value = min(merged_data$time_variable),
      label = "Time Period",
      animate = TRUE,
      width = "250px"
    )
  )

```



