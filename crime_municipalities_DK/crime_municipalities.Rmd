---
title: "crime_municipalities"
author: "Nikita"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r libraries, include=FALSE}
# Library 
library(raster)
library(rgeos)
library(sf)
library(tidyverse)
library(htmltools)
library(googlesheets4)
library(mapview)
library(leaflet)
library(shiny)
```


```{r load-municipalities-spatial-data, echo = FALSE}

# Load the spatial data, project to UTM
mun_sp<- getData('GADM', country = 'DK', level = 2)
mun_sf <- st_as_sf(mun_sp)
mun <- st_transform(mun_sf, crs = 25832)
st_crs(mun)

# Plot so as to check correct location and complete coverage
plot(mun$geometry)

# Check the names
mun$NAME_2

# Straighten the names (return here after Task 2)
mun$NAME_2[31] <- "Aarhus"
mun$NAME_2[21] <- "HÃ¸je-Taastrup"
mun$NAME_2[60] <- "Vesthimmerlands"


```


```{r load vold }
# read in data from csv
voldsforbrydelser <- read_csv2("data/forbrydelser_2012-22_numbers.csv")
befolkningstal <- read_csv2("data/befolkningstal_2012-22_numbers.csv")
# delete row 1 and 3 and column 1
#voldsforbrydelser <- voldsforbrydelser[-c(1,3), -1]
#rename colums with names of the first row
#colnames(voldsforbrydelser) <- voldsforbrydelser[1, ]
# delete row with rownames
#voldsforbrydelser <- voldsforbrydelser[-1,]
# drop NA-rows
#voldsforbrydelser <- voldsforbrydelser[complete.cases(voldsforbrydelser), ]
#drop 'ukendt kommune' row
#voldsforbrydelser <- voldsforbrydelser[-100,]
# pasting 'Y' before columnname
colnames(voldsforbrydelser) <- paste0("Y", colnames(voldsforbrydelser))
# rename the first column
colnames(voldsforbrydelser)[1] <- "municipalities"

# assign numbers as numbers
voldsforbrydelser[,2:12] <- sapply(voldsforbrydelser[ ,2:12], as.numeric)
# getting sum of rows
voldsforbrydelser$crime_sum <- rowSums(voldsforbrydelser[,2:12])


# edit befolkningstl csv
#befolkningstal <- befolkningstal[-c(1),]
#rename colums with names of the first row
#colnames(befolkningstal) <- befolkningstal[1, ]
# delete row with rownames
#befolkningstal <- befolkningstal[-1,]
# drop NA-rows
#befolkningstal <- befolkningstal[complete.cases(befolkningstal), ]
#drop 'ukendt kommune' row
#befolkningstal <- befolkningstal[-100,]
# pasting 'Y' before columnname
colnames(befolkningstal) <- paste0("Y", colnames(befolkningstal))
# rename the first column
colnames(befolkningstal)[1] <- "municipalities"

# assign numbers as numbers
befolkningstal[,2:12] <- sapply(befolkningstal[ ,2:12], as.numeric)
# getting sum of rows
befolkningstal$crime_sum <- rowSums(befolkningstal[,2:12])


crime_rate <- data.frame(Municipality = befolkningstal$municipalities)   # Create a new dataset with the Municipality column from the population dataset

years <- colnames(befolkningstal)[-1]   # Get the years from the population dataset columns

# Loop through each year and calculate the crime rate per 1000 population
for (year in years) {
  pop_col <- befolkningstal[, year]   # Get the population column for the current year
  crime_col <- voldsforbrydelser[, year]   # Get the crime column for the current year
  
  crime_rate[, year] <- (crime_col / pop_col) * 1000   # Calculate the crime rate per 1000 population for the current year
}


# Add columns for the change in crime rate per year
crime_data <- crime_rate %>%
    mutate(change_2013 = Y2013 - Y2012,
           change_2014 = Y2014 - Y2013,
           change_2015 = Y2015 - Y2014,
           change_2016 = Y2016 - Y2015,
           change_2017 = Y2017 - Y2016,
           change_2018 = Y2018 - Y2017,
           change_2019 = Y2019 - Y2018,
           change_2020 = Y2020 - Y2019,
           change_2021 = Y2021 - Y2020,
           change_2022 = Y2022 - Y2021)






```

```{r}

df <- mun %>% 
  select(NAME_2) %>% 
  merge(crime_data, by.x = "NAME_2",by.y ="Municipality")

```

```{r}
# Load required libraries
library(mapview)
library(shiny)
library(tmap)

# Create ui for shiny application
ui <- fluidPage(
  titlePanel("Danish Municipality Crime"),
  
  # Create a slider input for selecting the column
  sliderInput("columnSelect", "Select Column:",
              min = 14, max = 23, value = 14, width = "50%"),
  
  # Create a tmap output and make the map bigger
  tmapOutput("map", height = "1000px")
)

# Defining server function
server <- function(input, output, session) {
  
  # Render the map
  output$map <- renderTmap({
    
    # Get the selected column based on the slider input
    selectedColumn <- colnames(df)[input$columnSelect]
    
    # Create the map with fixed breaks between -50 and 50
    my_map <- df %>%
      tm_shape() +
      tm_fill(
        col = selectedColumn,
        title = paste("Crime per 1000 inhabitants:", selectedColumn),
        style = "cont",
        palette = "-RdBu",
        breaks = c(-50, seq(-40, 40, by = 10), 50),
        legend.hist = TRUE
      ) +
      tm_text(text = "NAME_2") +
      tm_view(set.view = 8)  # Set the initial zoom level here
    
    my_map
  })
}

# Calling shinyApp
shinyApp(ui, server)



```

```{r}
percentage_cols <- df[,2:21] / df$crime_sum*100
df[,2:21] <- percentage_cols
```





```{r Tmap with Shiny integrated}
# Load required libraries
library(mapview)
library(shiny)
library(tmap)

# Create ui for shiny application
  ui = fluidPage(
    titlePanel("Danish Municipality Crime"),
    
    # Create a slider input for selecting the year you wish to view
    sliderInput("columnSelect", "Select Column:",
              min = 14, max = 23, value = 14, width = "50%"),

    
    # Create a tmap output and make the map bigger
    tmapOutput("map",height = "1000px")
  )
  
  # Defining server function
  server= function(input, output, session) {

    
      # Render the map
      output$map <- renderTmap({
      
      # Get the selected column based on the slider input
      selectedColumn <- colnames(df)[input$columnSelect]
      

      
      # Creating the map itself and assigning it to the map object
      my_map <- df %>% 
                    # Using tm_shape function
                    tm_shape() + 
        
                    # Calling tm_polygons for drawing the polygons
                    tm_fill(selectedColumn,
                                title = paste("Crime per 1000 inhabitants:", selectedColumn),
                                style = "cont",
                                palette = "-RdBu",
                                legend.hist = TRUE) +

                  tm_text(text = "NAME_2") +
                  tm_view(set.view = 8)  # Set the initial zoom level here
 


      

    })
  }

# Calling server function
shinyApp(ui, server)



```


